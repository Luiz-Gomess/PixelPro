services:
  app:
    build: .
    # Para desenvolvimento
    # image: maven:3.9.8-eclipse-temurin-21
    # command: mvn spring-boot:run
    container_name: pixelpro
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/pixelpro
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=guest
      - SPRING_RABBITMQ_PASSWORD=guest
      - MINI_PASWORD=password123
      - MINIO_MAIN_BUCKET=pixelpro
      - MINI_USER=admin
      - MINI_URL=http://minio:9000
      - SERVER_CUSTOM_ADDRESS=http://localhost:8089/api/v1/job
    working_dir: /app
    ports:
      - "8089:8080"
    volumes:
      - .:/app
    depends_on:
      db:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_started

    networks:
      - pixelpro-network
  db:
    image: postgres:15
    container_name: postgres
    environment:
      - POSTGRES_DB=pixelpro
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      
    ports:
      - "5433:5432" 
    volumes:
      - postgres_data:/var/lib/postgresql/data 
    restart: always 
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d pixelpro"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    networks:
      - pixelpro-network

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: rabbitmq
    ports:
      - "5672:5672" # API Rabbit
      - "15672:15672" # Console Web
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - pixelpro-network
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"  # API S3
      - "9001:9001"  # Console Web
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: password123
      MINIO_MAIN_BUCKET: pixelpro
      MINIO_URL: http://localhost:9000
    volumes:
      - ./data:/data
    command: server /data --console-address ":9001"
    networks:
      - pixelpro-network

volumes:
  rabbitmq_data: 
  postgres_data:
  minio_data:
    driver: local

networks:
  pixelpro-network:
    driver: bridge